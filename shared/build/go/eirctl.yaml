contexts:
  go1x:
    container:
      name: public.ecr.aws/docker/library/golang:1-trixie
      enable_dind: true
      enable_mount: true
    envfile:
      exclude:
        - GO
        - CXX
        - CGO

  golint:
    container:
      name: docker.io/golangci/golangci-lint:v2.4.0-alpine
      enable_mount: true
    envfile:
      exclude:
        - GO
        - CXX
        - CGO
        - PATH
        - HOME

tasks:
  clean:
    command:
      - echo "running clean"
      - |
        rm -rf bin/*
        rm -rf dist/*
        rm -rf vendor/*
        rm -rf .coverage
  test_prereqs:
    description: Installs coverage and junit tools
    command:
      - |
        mkdir -p .coverage
        go install github.com/jstemmer/go-junit-report@v0.9.1 && \
        go install github.com/axw/gocov/gocov@v1.0.0 && \
        go install github.com/AlekSi/gocov-xml@v1.0.0
    allow_failure: true

  vuln:check:
    context: go1x
    description: |
      Runs a vulnerability scan against the code base
    command:
      - |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./...

  test:
    command:
      - |
        mkdir -p .coverage
        go test $(go list ./... | grep -v /local/) -v -coverpkg=./... -race -mod=readonly -shuffle=on -buildvcs=false -coverprofile=.coverage/out -count=1 -run=$GO_TEST_RUN_ARGS | tee .coverage/test.out
        cat .coverage/test.out | go-junit-report > .coverage/report-junit.xml
        gocov convert .coverage/out | gocov-xml > .coverage/report-cobertura.xml
    env:
      GOFLAGS: -buildvcs=false
      # GO_TEST_RUN_ARGS: "Test_ImagePull"
    allow_failure: true

  show_coverage:
    command:
      - echo "Opening coverage html page"
      - go tool cover -html=.coverage/out

  golint:
    # dir: {{ if .WorkingDir .Dir }}
    context: golint
    description: Runs the linter and go vet and other default static checks
    allow_failure: false
    command:
      - |
        golangci-lint run

pipelines:
  test:unit:
    - task: clean
    - task: test_prereqs
    - task: test
      depends_on:
        - clean
        - test_prereqs

  show:coverage:
    - pipeline: test:unit
    - task: show_coverage
      depends_on:
        - test:unit
  lints:
    - task: golint
    - task: vuln:check
    # govet is run as part of golint
    # - task: govet